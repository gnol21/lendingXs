$(document).ready((function(){let t="https://iptv.givethanksgrocers.com/lending/loan.php",e=0;function n(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function a(t){return!isNaN(t)&&null!==t&&""!==t}function d(t){t?($("#loading-spinner").show(),$("button").prop("disabled",!0)):($("#loading-spinner").hide(),$("button").prop("disabled",!1))}function o(){d(!0),$.ajax({url:t,method:"GET",success:function(t){let a=$("#table-body");a.empty(),e=0;let o=function(){let t=new Date,e=("0"+t.getDate()).slice(-2),n=("0"+(t.getMonth()+1)).slice(-2);return t.getFullYear()+"-"+n+"-"+e}();t.forEach((function(t){e++,a.append(`<tr data-id="${t.LoanID}">\n                            <td>${e}</td>\n                            <td class="text-capitalize">${t.BorrowerName}</td>\n                            <td>${t.LoanDate}</td>\n                            <td >₱${n(t.LoanAmount)}</td>\n                            <td >${t.InterestRate}</td>\n                            <td >${t.TermMonths}</td>\n                            <td>₱${n(t.MonthlyPayment)}</td>\n                            <td>₱${n(t.TotalAmountDue)}</td>\n                            <td>${t.DueDate}</td>\n                            <td class="text-center">\n                                <button class="btn btn-danger btn-sm delete-btn" data-id="${t.LoanID}" style="width: 100%;">Delete</button>\n                            </td>\n                        </tr>`)})),a.append(`<tr>\n                        <td>${e+1}</td>\n                        <td class="text-capitalize editable-name" contenteditable="true"></td>\n                        <td><input id="loan-date" class="border-0" value="${o}" type="date" style="width: 100%;" /></td>\n                        <td class="editable-loan-amount" contenteditable="true"></td>\n                        <td class="editable-interest-rate" contenteditable="true"></td>\n                        <td class="editable-term" contenteditable="true"></td>\n                        <td class="table-secondary monthly-payment"></td>\n                        <td class="table-secondary total-amount-due"></td>\n                        <td class="table-secondary due-date"></td>\n                        <td class="text-center"><button class="btn btn-primary btn-sm add-btn" type="button" style="width: 100%;">Add</button></td>\n                    </tr>`),d(!1)},error:function(){alert("Failed to fetch loans"),d(!1)}})}function l(){let e=$("#loan-date").val(),n=$("td.editable-name").text().trim(),l=parseFloat($("td.editable-loan-amount").text().replace(/[^0-9.-]+/g,"")),i=parseFloat($("td.editable-interest-rate").text()),r=parseInt($("td.editable-term").text());n&&a(l)&&a(i)&&a(r)?(d(!0),$.ajax({url:t,method:"POST",contentType:"application/json",data:JSON.stringify({borrowerName:n,loanDate:e,loanAmount:l,interestRate:i,termMonths:r,status:"Active"}),success:function(){alert("Loan added successfully"),$("td.editable-loan-amount, td.editable-interest-rate, td.editable-term").text(""),$("#loan-date").val(""),$("td.monthly-payment, td.total-amount-due, td.due-date").text(""),o()},error:function(t,e,n){console.error("Error:",n);var a=JSON.parse(t.responseText);alert("Error: "+a.message),d(!1)}})):alert("Please fill in all required fields correctly.")}$(document).on("click",".add-btn",(function(){l()})),$(document).on("click",".delete-btn",(function(){!function(e){confirm("Are you sure you want to delete this loan?")&&(d(!0),$.ajax({url:`${t}?id=${e}`,method:"DELETE",success:function(){alert("Loan deleted successfully"),o()},error:function(){alert("Failed to delete loan"),d(!1)}}))}($(this).data("id"))})),$(document).on("click",".edit-btn",(function(){$(this).closest("tr").find(".editable-loan-amount, .editable-interest-rate, .editable-term").attr("contenteditable",!0),$(this).text("Save").removeClass("edit-btn btn-warning").addClass("save-btn btn-success")})),$(document).on("click",".save-btn",(function(){!function(e){const n=e.data("id"),d=e.find(".editable-loan-amount").text().replace(/[^0-9.-]+/g,""),l=e.find(".editable-interest-rate").text(),i=e.find(".editable-term").text();a(d)&&a(l)&&a(i)?$.ajax({url:`${t}?id=${n}`,method:"PUT",contentType:"application/json",data:JSON.stringify({loanAmount:parseFloat(d),interestRate:parseFloat(l),termMonths:parseInt(i)}),success:function(){alert("Loan updated successfully"),o()},error:function(){alert("Failed to update loan")}}):alert("Please provide valid numbers for all fields.")}($(this).closest("tr"))})),$(document).on("input",'td[contenteditable="true"], #loan-date',(function(){!function(){let t=parseFloat($("td.editable-loan-amount").text().replace(/[^0-9.-]+/g,"")),e=parseFloat($("td.editable-interest-rate").text())/100,d=parseInt($("td.editable-term").text());if(a(t)&&a(e)&&a(d)&&d>0){let a=t*(1+e*d),o=a/d;$("td.monthly-payment").text("₱"+n(o.toFixed(2))),$("td.total-amount-due").text("₱"+n(a.toFixed(2)));let l=new Date($("#loan-date").val());if(!isNaN(l.getTime())){l.setMonth(l.getMonth()+d);let t=l.toISOString().split("T")[0];$("td.due-date").text(t)}}else $("td.monthly-payment, td.total-amount-due, td.due-date").text("N/A")}()})),o()}));