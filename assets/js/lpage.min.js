$(document).ready((function(){let t="https://iptv.givethanksgrocers.com/lending/loan.php",e=0;function n(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function a(t){let e=t.split("-");return e[2]+"-"+e[1]+"-"+e[0]}function d(t){return!isNaN(t)&&null!==t&&""!==t}function o(t){t?($("#loading-spinner").show(),$("button").prop("disabled",!0)):($("#loading-spinner").hide(),$("button").prop("disabled",!1))}function l(){o(!0),$.ajax({url:t,method:"GET",success:function(t){let d=$("#table-body");d.empty(),e=0;let l=function(){let t=new Date,e=("0"+t.getDate()).slice(-2),n=("0"+(t.getMonth()+1)).slice(-2);return t.getFullYear()+"-"+n+"-"+e}();d.append(`<tr>\n                        <td>New</td>\n                        <td class="text-capitalize editable-name" contenteditable="true"></td>\n                        <td><input id="loan-date" class="border-0" value="${l}" type="date" style="width: 100%;background: #f2f2f2;" /></td>\n                        <td class="editable-loan-amount" contenteditable="true"></td>\n                        <td class="editable-interest-rate" contenteditable="true"></td>\n                        <td class="editable-term" contenteditable="true"></td>\n                        <td class="table-secondary monthly-payment"></td>\n                        <td class="table-secondary total-amount-due"></td>\n                        <td class="table-secondary due-date"></td>\n                        <td class="text-center"><button class="btn btn-primary btn-sm add-btn" type="button" style="width: 100%;">Add</button></td>\n                    </tr>`),t.forEach((function(t){e++,d.append(`<tr data-id="${t.LoanID}">\n                            <td>${e}</td>\n                            <td class="text-capitalize">${t.BorrowerName}</td>\n                            <td>${a(t.LoanDate)}</td>\n                            <td >₱${n(t.LoanAmount)}</td>\n                            <td >${t.InterestRate}</td>\n                            <td >${t.TermMonths}</td>\n                            <td>₱${n(t.MonthlyPayment)}</td>\n                            <td>₱${n(t.TotalAmountDue)}</td>\n                            <td>${a(t.DueDate)}</td>\n                            <td class="text-center">\n                                <button class="btn btn-danger btn-sm delete-btn" data-id="${t.LoanID}" style="width: 100%;">Delete</button>\n                            </td>\n                        </tr>`)})),o(!1)},error:function(){alert("Failed to fetch loans"),o(!1)}})}function r(){let e=$("#loan-date").val(),n=$("td.editable-name").text().trim(),a=parseFloat($("td.editable-loan-amount").text().replace(/[^0-9.-]+/g,"")),r=parseFloat($("td.editable-interest-rate").text()),i=parseInt($("td.editable-term").text());n&&d(a)&&d(r)&&d(i)?(o(!0),$.ajax({url:t,method:"POST",contentType:"application/json",data:JSON.stringify({borrowerName:n,loanDate:e,loanAmount:a,interestRate:r,termMonths:i,status:"Active"}),success:function(){alert("Loan added successfully"),$("td.editable-loan-amount, td.editable-interest-rate, td.editable-term").text(""),$("#loan-date").val(""),$("td.monthly-payment, td.total-amount-due, td.due-date").text(""),l()},error:function(t,e,n){console.error("Error:",n);var a=JSON.parse(t.responseText);alert("Error: "+a.message),o(!1)}})):alert("Please fill in all required fields correctly.")}$(document).on("click",".add-btn",(function(){r()})),$(document).on("click",".delete-btn",(function(){!function(e){confirm("Are you sure you want to delete this loan?")&&(o(!0),$.ajax({url:`${t}?id=${e}`,method:"DELETE",success:function(){alert("Loan deleted successfully"),l()},error:function(){alert("Failed to delete loan"),o(!1)}}))}($(this).data("id"))})),$(document).on("click",".edit-btn",(function(){$(this).closest("tr").find(".editable-loan-amount, .editable-interest-rate, .editable-term").attr("contenteditable",!0),$(this).text("Save").removeClass("edit-btn btn-warning").addClass("save-btn btn-success")})),$(document).on("click",".save-btn",(function(){!function(e){const n=e.data("id"),a=e.find(".editable-loan-amount").text().replace(/[^0-9.-]+/g,""),o=e.find(".editable-interest-rate").text(),r=e.find(".editable-term").text();d(a)&&d(o)&&d(r)?$.ajax({url:`${t}?id=${n}`,method:"PUT",contentType:"application/json",data:JSON.stringify({loanAmount:parseFloat(a),interestRate:parseFloat(o),termMonths:parseInt(r)}),success:function(){alert("Loan updated successfully"),l()},error:function(){alert("Failed to update loan")}}):alert("Please provide valid numbers for all fields.")}($(this).closest("tr"))})),$(document).on("input",'td[contenteditable="true"], #loan-date',(function(){!function(){let t=parseFloat($("td.editable-loan-amount").text().replace(/[^0-9.-]+/g,"")),e=parseFloat($("td.editable-interest-rate").text())/100,a=parseInt($("td.editable-term").text());if(d(t)&&d(e)&&d(a)&&a>0){let d=t*(1+e*a),o=d/a;$("td.monthly-payment").text("₱"+n(o.toFixed(2))),$("td.total-amount-due").text("₱"+n(d.toFixed(2)));let l=new Date($("#loan-date").val());if(!isNaN(l.getTime())){l.setMonth(l.getMonth()+a);let t=l.toISOString().split("T")[0];$("td.due-date").text(t)}}else $("td.monthly-payment, td.total-amount-due, td.due-date").text("N/A")}()})),l()}));